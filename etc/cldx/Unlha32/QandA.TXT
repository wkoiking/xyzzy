###### 頻出質問集 ######

　『UNLHA32.DLL 対応アプリ使用編』と『UNLHA32.DLL  対応アプリ開発編』に
分かれてはいますが， これは質問者がどちらを重点にしていたかというだけの
違いでしかないので，双方とも目を通したほうがいいです。

　なお，『対応アプリ使用編』については，LHMelt を対象にして書いてありま
すが，すべての質問が LHMelt についてのものだったわけではありません。


[UNLHA32.DLL 対応アプリ使用編]

  ・『エンドマークが存在しません』と表示される

        　LZH 系の書庫では， 終端に書庫の終わりであることを示す 0x00 の
        エンドマークが入る仕様となっていますが，一部のソフトにおいては，
        必要なエンドマークの付加されていない書庫が作成されてしまいます。

        　『たまたまメンバー終端の位置を境に後続のデータが欠落していた』
        といった場合を除いて， UNLHA32.DLL を含めた多くのアプリやツール
        では問題なく書庫を扱えるのですが， エンドマークの存在しないこと
        が原因で， 書庫が破損したり失われたりしてしまうツール等があるら
        しく，『書庫が破損・亡失した』という報告例が何件かありました。

        　そのため， UNLHA32.DLL においては，そのような書庫については不
        正扱いとしてエラーを返すようになっています。

  ・『ライブラリのロードができませんでした』と表示されて  LHMelt が使え
    ない。

        　この質問メールの場合は，"not installed." が申告されている以上
        DLL が正常にインストールされていないとしか考えられません。 少な
        くともシステムがファイルを見つけられなかったのは確かです。 ファ
        イル自体が見つかっている状況であれば， "load error." 等，他のエ
        ラーが申告されます。

  ・作成した自己解凍書庫を Windows Vista 上で実行しようとすると，管理者
    権限での実行を求められる。
  ・作成した自己解凍書庫を Windows Vista 上で実行して展開を行うと，プロ
    グラム互換性アシスタントが表示される。

        　UNLHA32.DLL が作成する WinSFX32(M) は Windows Vista の UAC に
        対応していますので， 基本的に次のような場合を除いてプログラム互
        換性アシスタントが表示されることはありません：

                ・$ ファイルが使用されたインストーラ相当の WinSFX32M
                ・UAC の機能がオフとなっている
                ・旧版の UNLHA32.DLL で作成された UAC 未対応の SFX

        　これらの場合は WinSFX32M の構造がシステムにより自動解析され，
        インストーラ相当のプログラムとして認識・取り扱われる結果となり
        ます。設定等で認識方法を変更することは出来ませんので， 現状では
        避けることが不可能です。

        　インストーラとして認識された場合， 管理者権限での実行を求めら
        れるだけでなく， アンインストール情報が登録されたかどうか追跡・
        チェックされ， 登録が行われなかった場合にはプログラム互換性アシ
        スタントが表示されます。

  ・展開しようとすると，いつも『UNLHA32.DLL が見つかりません』というメッ
    セージが出る。

        　UNLHA32.DLL が正常にインストールされていないか， していないだ
        けでしょう。 この質問の場合は，どっかの雑誌付属のブラウザが作成
        したデスクトップ上のフォルダに展開されていました。(笑) 他書庫用
        の DLL については正しくインストールされていて，アプリ自体は正常
        起動していたことが，話を難しくしたようです。

  ・LZH 以外の書庫が作成できない。

        　UNLHA32.DLL は  LZH 書庫専用となっています。『統合アーカイバ
        プロジェクト』系の DLL を使用するアプリでは， 各書庫毎に専用の
        DLL が必要となりますので， 例えば ZIP 書庫であれば UNZIP32.DLL
        を別途入手してインストールを行ってください。 必要となる DLL や
        入手方法については，アプリのドキュメント等に記述されているはず
        です。

  ・LHMelt で圧縮を行おうとすると，『レスポンスファイルが読めません』の
    エラーが出て，圧縮できない。

        　PC-9801 系のマシンで Win9x 系の OS を使用している場合に再現し
        やすい不具合で，今なお原因不明のものです。 なぜかは解らないので
        すが， ユーザ自身による設定の有無にかかわらず初期値である
        "C:\WINDOWS\TEMP" が作業ディレクトリーになっていると発生します。
        ファイルが開けない以前にディレクトリーへのアクセス自体が拒否さ
        れている例もあって，他のアプリも全滅となっていたりします…。
        (^^;;

        　不思議なことに， 他のディレクトリーを明示的に環境変数で指定す
        ると，何事もなかったかのごとく動作します。

  ・ソフトを実行しようとすると『バージョンが古い』と怒られて使えない。

        　『古い』と言っている以上新しいものを使うしかありません。 深く
        考えてはいけません。ただし， 他のアプリ等が古い版を要求している
        ことがありますので， システムディレクトリーにインストールしてい
        る場合は注意してください。

  ・Windows 2K を使用しているが， Windows 95 と違うので，どこに入れれば
    良いのか判らない (98 も)。

        　一昔前なら『システムディレクトリーも判らずに  NT なんか使うな』
        とでも言われそうなパターンです。 "C:\WINNT\SYSTEM32" に入れるの
        が基本。ただし，普通にインストールしてあるのなら…ですが。
        　しかし，このレベルだと，ME や 2K では『フォルダが表示できませ
        ん』って質問が飛んできそうだなぁ…って， 実際飛んできているわけ
        ですけれど。

        　最近の版であれば， ことオリジナルの配布書庫を使う限りは実行す
        ることでインストールが行われるのですが， 雑誌収録その他では書庫
        形式変更等が意外と多く， 手動インストールが必要になってしまうの
        が難点ですね。

        　なお， 環境によっては C ドライブでなかったり  "C:\WINDOWS\〜"
        だったりするので，注意。

  ・DLL とは何か？ どうやって手に入れ，どこにインストールすればいいのか
    解らない。

        　『DLL とは何か？』の部分になると， すでに私が説明すべき範疇で
        はなくなっています。(笑) 簡単に言えば，『特定の処理を行う (ソフ
        トの) 部品』です。

        　とりあえず， 質問がくるということは，既に手に入れているか『ソ
        フトの手に入れ方』は知っていることになるので， あとは対応アプリ
        なり DLL なりのドキュメント等を参照してインストールを行えばよい
        でしょう。 UNLHA32.DLL に限れば，実行形式ファイルでの配布となっ
        ていますから，直接実行することでインストールが可能です。

  ・『ハフマンコードが破損』のメッセージが出て展開できない。

        　残念ながら書庫が壊れてしまっています。 ソフトによっては展開作
        業を継続できますが， 少なくともその当該ファイルだけは諦めざるを
        得ません。

  ・空のフォルダが圧縮されない。

        　アプリが対応していない可能性もありますが， 大抵は当該機能が有
        効となっていないのが原因です。 たとえば LHMelt であれば圧縮関係
        の『lhd メンバーを作成』を有効にしておく必要があります。

  ・英語版の自己解凍書庫を作成しても日本語版になってしまう。

        　比較的最近の UNLHA32.DLL では，WinSFX32(M) についてはバイリン
        ガル化されています。 そのため，日本語環境に於いては常に日本語で
        の動作となります。$Language が使用可能な版の WinSFX32M であれば，
        このコマンドを使用して  $Language=-1 などと登場しそうもない言語
        ID を指定することで，常に英語版の動作とすることが可能です。

  ・英語環境で実行しても WinSFX32(M) が英語版の動作とならない。

        　バイリンガル版の WinSFX32(M) では，$ ファイルにおいて日本語版，
        英語版両方のコマンドを記述しておく必要があります。 日本語用と英
        語用にコマンドが分かれている点に注意してください。

  ・SFX (自己解凍書庫) とは何のことですか？

        　『他のツール等を必要とせず， 自分自身を実行することで展開が可
        能な実行ファイルとなっている書庫』のことです。  Self Extraction
        Module の略。ZIP 等，他のツールでも使われている略称なので，覚え
        ておいて損はないです。

  ・DLL の設定ダイアログが呼び出せるソフトを教えて。

        　対応ソフトを作るのは私ではありませんので， 私に質問しても回答
        しようがありません。…というのは置いておいて， 一発展開・圧縮系
        でない限り，最近のアーカイバー関連ソフト (ただし DLL を使うも
        の) なら大抵呼び出せるはずです。拙作の LHMelt でも可能です。

        　ただし，"-+" スイッチを使っているソフトが多いので，設定が無効
        という場合の多いのが実情です。

        　なお，"-+" を指定しているのに設定ダイアログを呼び出せる…とい
        うのは，実は仕様バグです。 何しろ，設定を行っても，それが使われ
        ることは無いわけですから。(^^;)

        　設定ダイアログでの設定は， 他のアプリの動作にも影響しますので
        注意が必要となります。

  ・英語の表示になってしまう。

        　システムまたはカレントユーザの地域設定が日本語以外となってい
        るのが原因と思われます。…というか，そうなっていないと英語表示
        にならないはずです。

        　なお， 『LHMelt で言語設定を英語にしていた』というパターンも
        過去にあったので，システムや対応アプリの設定確認は必須です。

  ・英語版の LHMelt があるのか教えてほしい。

        　今では『英語版』というのは存在しません。 が，英語環境で実行可
        能となっていますし，メッセージ等も切り替わります。

  ・LHMelt のアンインストール方法が解らない。

        　Ver 1.18b 以降なら， スタートメニューの『アンインストール』か
        『アプリケーションの追加と削除』機能が使えます。 後者は，その機
        能がある OS のみで有効。

  ・UNLHA32.INF でインストールを行おうとしても， ディスクが要求されてし
    まいインストールできない。

        　まず， 最近の版なら実行ファイルがインストーラ代わりとなってい
        ますから，INF ファイルを直接利用する必要はありません。 が，付録
        CD-ROM 等だと作者の要請を無視して通常の書庫に改悪してあったりし
        ますが (独自のインストールを行うものを除く)…。

        　一方，古い版の場合。 …って，このドキュメントが存在するってこ
        とは，上記の新しい版に含まれるわけですが…。

        　IE 4.0 以降がインストールされていない環境だと，必要なシステム
        DLL が存在しない場合があります。 Win95 SP1 以前のものは仕方がな
        いとして，基本的に OSR 2.0 以降のものは大丈夫なはずですが，なぜ
        か Win98 等を含めて正常に機能しない環境が存在します。少なくとも
        まっさら状態から当該 OS  を入れた環境では可能なので，あとはプリ
        インストールを含めて『環境の問題』であって， 私にはどうしようも
        ありません。 INF ファイル自体は特に特殊な指定が行われているわけ
        ではありませんし， 再現しないことには調査のしようがありませんの
        で。

        　最終的には，手動でコピーするしか方法がありません。 たった一つ
        のファイルをコピーするだけなので，私の Web ページ等でも参考にし
        て，なんとかコピーしてください。(^^;;

  ・書庫の読み込みが死ぬほど遅い。

        　リストボックスへ表示しながら読み込んでいる場合，NT 系ではシス
        テムの仕様から格納ファイル数が多くなると Win9x に対して相当処理
        時間の長くなることが予想されます。

        　それとは別に， 最近ではなくなりましたが，一部のウィルス監視ソ
        フト等では， 書庫へ読みに行くたびに書庫全体をチェックしてしまう
        ため，OpenArchive() 系を使っているであろう多くのアプリに於いて，
        実質ハング同然の状態に陥ってしまいます。たとえば，10 万のファイ
        ルを格納した 2GB の書庫であれば， 最低でも 10 万回 2GB の書庫を
        チェックしてしまうことになり， 結果『半日経っても読み込みが終了
        しない』という事態に陥ってしまいます。回避するには， 危険を冒し
        て当該ツールの書庫チェック機能をオフにするしかありません。

        　このような『読むたびにチェック』を行わない大抵のソフトでは，
        OpenArchive() 系を使用していたとしても， 書庫を開いて閉じるまで
        に 1 度か 2 度のチェックしか行わないので， 格納ファイル数は影響
        しません。

  ・DLL を Ver 0.44 から 1.53d に更新したところ， LHMelt で格納ファイル
    が表示されなくなり展開もできなくなった。

        　言及されていませんが，Ver 0.44 が使用できていることから，相当
        古い LHMelt を使用していたのが原因と思われます。 それとは別に，
        『格納ファイルが表示されない』という現象から， 単に "-p" スイッ
        チ周りの問題である可能性もあります。こちらに該当する場合は，LH-
        Melt の設定が問題となっているとは限りませんので，UNLHA32.DLL の
        設定ダイアログ等もチェックする必要があります。(^^;)

  ・パソコンを立ち上げる度に『UNLHA32.DLL  の展開を行います』のメッセー
    ジが出る。

        　言及されていないので判りませんが， 単に配布ファイルがスタート
        アップに置かれてしまっている可能性が大。 削除すればいいわけなの
        ですが，どうもそれが判らないレベルの方らしい…。(^^;;

  ・LHMelt でフォルダ単位で圧縮されたものを展開できますか？

        　できないと私が困ります。(笑) 初期値のまま弄っていないのであれ
        ば可能になっているはずなので，できないのであれば， 本人を含めた
        『誰か』が設定を変更したことになります。 意外と多いのは『パスな
        しの展開を指定していた』『そもそもパスなしで格納された書庫だっ
        た』というものです。

  ・ファイルを圧縮したいがどのソフトを使えばいいか？

        　最後は個人の好みに寄るところが大なので， メジャーなソフトから
        良さげなものを適当に選んで， とにかく自分で実際に使ってみるのが
        近道です。

  ・"UNLHA32.DLL" という名前のファイルがあると LZH 書庫が扱えない。

        　多くのアプリでは，今から扱おうとする書庫の存在するディレクト
        リーをカレントディレクトリーに設定します。システムは最初にカレ
        ントディレクトリーから DLL を探すので， そこに『名前が同じであ
        るだけの別物のファイル』があれば， 本来使用すべきはずの UNLHA-
        32.DLL を扱えないことになります。何もこれは UNLHA32.DLL に限っ
        た話ではありません。

        　なお， 一部のプラットフォームでは各 DLL についてロード先を指
        定することができます。このような環境であれば，適切な設定を行え
        ばこの不具合を回避することが可能です。


[UNLHA32.DLL 対応アプリ開発編 (含むコマンド関係)]

  ・状況表示やエラーメッセージ等のダイアログを表示させたくない。

        　状況表示を抑止するには "-n" スイッチを使用しますが，このスイッ
        チだけではエラーメッセージについては抑止されません。 エラーメッ
        セージも抑止したい場合は，必ず "-gm" スイッチも付加するようにし
        てください。

  ・複数のスレッドから同時に呼び出すことができないのか？

        　残念ながら， UNLHA32.DLL はスレッドセーフではないので，マルチ
        スレッドには対応していません。 それどころか，Unlha  系と  Open-
        Archive 系といった API の混在すら行えないのが実情です。

  ・マルチボリューム書庫が作成できるのか？

        　オリジナルを含め UNLHA32.DLL はマルチボリューム書庫に対応して
        いないので作成不可能です。 何らかの分割ソフト等を併用するしかな
        いでしょう。

  ・ERROR_TMP_COPY が出て書き戻しが行えない。

        　このエラーが出るのは次の場合です :

                 ・書庫操作に書庫の更新が伴わなかった場合は，退避され
                   た作業書庫が対象書庫として MoveFile() API により復
                   元されますが，その MoveFile() API 呼び出しが失敗し
                   た場合。
                 ・更新を伴った場合は，操作結果としての作業書庫が対象
                   書庫として保存されますが，その際に，
                        1 : 保存先として対象書庫を開く際の  MyCreate-
                            File() が失敗した場合。
                        2 : 保存元として作業書庫を開く際の   myopen2()
                            (実体は MyCreateFile()) が失敗した場合。
                        3 : 保存終了時の  MyCloseFileHandle() が失敗し
                            た場合。
                        4 : 処理開始時に記憶しておいたタイムスタンプを
                            書き込むための， MyCreateFile()， MyClose-
                            FileHandle() に失敗した場合。

        　実際には後者の 4 の段階で共有エラーになっていることが多いです。
        非同期アクセスではないので， WIN32 API が正常値を返している以上
        は処理が終了しているはずなのですが，実際には 3 で行われる Close-
        Handle() の終了していないのが原因となっています。負荷の高いネッ
        トワークで発生率が高くなっているようです。 それとは別に，監視ソ
        フト等がファイルを離さない…というパターンも発生しています。 こ
        ちらは， 自分 (監視ソフト) がファイルを離していないのにもかかわ
        らず，フックした WIN32 API に正常値を返させているのが原因です。

  ・空のフォルダが圧縮されない。

        　オリジナルの LHA.EXE がそうであるように，UNLHA32.DLL において
        も通常は空のフォルダについては圧縮・格納が行われません。 格納す
        るには "-x1r2a2" 又は省略形の "-d" を指定する必要があります。こ
        の場合，"-a2" が "-a1" の機能を含むことから，特殊属性等のファイ
        ルも格納される点に注意が必要となります。

  ・LZH 書庫が含まれる ZIP 書庫を LZH 書庫として認識してしまう。

        　多くのツールでは， LZH 書庫についてはファイルの先頭部分を検索
        して認識が行われるのに対して， ZIP 書庫では，ファイルの終わりに
        存在するインデックスヘッダを利用して認識が行われます。そのため，
        誤認識を避けるのは基本的に不可能です。 Ver 1.64 以降の UNLHA32.
        DLL では， 互換性を犠牲にして書庫の後ろの追加データを認めないよ
        うにすることで， そのような入れ子の書庫に対する誤認識を軽減する
        ようになっています。

  ・UNLHA32.DLL は無料なんですか？

        　フリーソフトウェアなので無料です。 サイトによってはカンパ等を
        促すところもあるようですが…。 そのような場合でも，個人が開設し
        ているサイトの運営費等へのカンパであって， その旨説明もされてい
        るはずです。 もし，ソフト自体 (つまり UNLHA32.DLL) の使用料であ
        るのなら，それは不正に請求していることになるので， そのようなと
        ころからダウンロードしてはいけません。

  ・UNLHA32.DLL を英語 OS 上で使えるのか？

        　正式に対応を表明できるテスト環境をもっていませんので『はい』
        とは言えないのですが(笑)， 特殊な環境ではなく，メッセージを始め
        とした表記の問題さえクリアできる  (英語もどきのメッセージで我慢
        できる) のであれば，正常に動作するようです。

        　表記の問題については， 一応レジストリーを利用して置き換えるこ
        とが可能となっています。詳しくは STRTABLE.TXT を参照してくだ
        さい。

  ・以下のコードでネットワーク上のファイルの展開がうまく行えない。

    lRet = Unlha(hwnd, "e -+ -m1a1x1c1f0 -jp1 " & strLhaFile & " " &
               strList, strBuf, Len(strBuf))

        　これだけでは情報が足りないので特定はできませんが，VB 使いにあ
        りがちなものとしては， 『パス情報を付加していない』『'"' で括っ
        ていない』というものがあります。

  ・レスポンスファイルのリストどおりに圧縮してくれない。

    <リスト>
    C:\Program files\test\a.txt
    C:\dir\test\b.txt

        　レスポンスファイル内は， 改行をセパレータとして扱う点のみが通
        常のコマンド指定と異なっています。 従って，空白を含む名前を扱い
        たいのであれば '"' で括る必要があります。

  ・パス情報を無視して同一ディレクトリーに展開したい。

        　'e' コマンドを使うか "-x0" スイッチを使うのが普通です。という
        か，COMMAND.TXT に書いてありますけど…？

  ・"dir1/subdir1/work.txt" というファイルを "C:/dir2/subdir3/work.txt"
    として展開したい。

        　残念ながらできません。展開するファイルが 1 個だけなら展開先を
        直接指定した上で 'e' コマンド辺りで展開すれば可能ですが…。どう
        してもやりたいのであれば， UnlhaSetEnumMembersProc() によるコー
        ルバック関数を使うことになりますが， 当然ながら対応アプリ側でパ
        ス情報の変換を行う必要があります。

  ・"subdir1" 上のすべてのファイルを  "subdir2/subdir1/〜" として格納し
     たい。

        　最近の版であれば，"-jb" スイッチを使用すれば可能です。 この場
        合であれば "-jbsubdir2" を指定することになります。

  ・.GID ファイル等が圧縮できない。

        　通常，UNLHA32.DLL  はシステム・隠し等特殊属性のファイルを扱い
        ません。 そういったファイルを扱いたい場合には "-a" スイッチを使
        用してください。

  ・SID 等が継承されない。

        　UNLHA32.DLL は SID 等を扱いません。一時期アクセス権等への対応
        化の話が出たことはありますが， 『下手に継承されると展開したファ
        イルが使えなくて困ることのほうが多い』という意見が多数だったこ
        とから，対応されることはありませんでした。

  ・4GB を越えるファイルが扱えない。

        　現在の版には，この制限は存在しません。 当然ですが，一覧表示等
        を行わない一発展開系のソフトでもない限りは， 『対応ソフト』側で
        も，そのようなファイルを扱える必要があります。

  ・短いファイル名で展開されてしまう。

        　もっとも可能性の高い原因は， 自分で行ったか何らかのソフトによ
        り行われたかは別として， "-ji" スイッチに関するレジストリー設定
        が行われている…というものです。 それとは別に MO 等を使用してい
        た場合など， 本来ならロングファイル名が使えるはずなのに，システ
        ムが使えないと申告 (GetVolumeInformation() の返却値が使えないこ
        とを示す) する…といった現象の発生する場合もあります。

        　さらに，比較的最近の版では，"-o" スイッチが使われた場合は、明
        示的に指定していなくとも短いファイル名となります  (LHA 互換の動
        作となる)。

  ・WinSFX32 等で SFX の作成時も実行時もダイアログ等を表示させたくない。

        　まず， 作成時については，通常の操作と何ら変わる点がありません
        ので "-n" スイッチで抑止が可能です。 また，作成時の設定ダイアロ
        グについては "-gw" スイッチで指定が可能です。

        　それに対して， 実行時については抑止するのは不可能なので，自動
        実行を利用して代替的な処理を行わせるしかありません。 スイッチで
        すべて指定するのは不可能なので， $ ファイルを使うことになります。
        詳しくは該当ドキュメントを参照。

  ・SFX について，展開後当該ディレクトリーを表示したい。

        　SFX 自身にそのような機能はありません。コマンド指定等で Explo-
        rer を実行する…などの方法しかないでしょう。

  ・英語環境で ! や $ ファイルが機能しない。

        　比較的最近の版で作成される WinSFX32(M) はバイリンガルとなって
        いますので， 英語環境で動作させるのであれば !E  が必要となり，$
        ファイルについても英語環境用のコマンドを指定する必要があります。
        詳しくはドキュメント参照。

  ・自己解凍書庫を作成したが，ロングファイル名のファイルを展開できない。

        　ロングファイル名を扱えるのは WinSFX32(M) だけなので，"-gw" ス
        イッチを使用して WinSFX32(M) の作成を指示する必要があります。
        UNLHA32.DLL は Win32 用ですが，『LHA.EXE 互換のコマンド体系』と
        なっている関係上，'s' コマンドのみの指定で作成されるのは DOS 用
        の DosSFX 2.67 となります。

  ・DLL を 0.85 から 1.52a に更新したところ，単一ファイルの展開にかかる
    処理時間が (めちゃくちゃ) 増大した。

        　格納ファイル検索打ち切り処理が新版で行われないのが原因です。
        普遍的に通用する打ち切り方法がなく， どこかで必ず不具合が出てし
        まうため機能が削除されました。 一応，限定的な打ち切り処理は再実
        装されていますが，根本的には避けられません。

  ・圧縮展開を行うと，タイマーみたいなアイコンに変わってしまう。

        　UNLHA32.DLL  は通常独自カーソルを表示するようになっていますの
        で，抑止したい場合は UnlhaSetCursorMode() を使用してください。

  ・"test.txt" のようなファイルがあると自己解凍書庫が作成できない。

        　DOS  用である DosSFX では通常小文字の名前は拒否されます。作成
        時に大文字に変換させるか， 元となる書庫に大文字で格納しておくし
        かありません。

        　DosSFX で無理矢理小文字の名前のファイルを展開した場合，DOS の
        環境にもよりますが， FAT エディタ等の専用ツールを使わない限り二
        度と削除できなくなる可能性があります。

  ・ファイル名等が文字化けする。

        　LZH 書庫での文字コード体系については，オリジナル (LHA.EXE) で
        使用されていたことから， 多くはシフト JIS  が採用されています。
        しかし，海外 (環境が日本語以外) で作成されたものや， 日本国内で
        あっても Windows，MS-DOS 以外の環境で作成された書庫では，シフト
        JIS 以外の文字コードとなっている場合があります。 従って，異なる
        環境で使用される可能性のある書庫については， 特定の文字コードを
        想定しないようにする必要があります。

        　'_' の文字に変換される現象については，API.TXT の UnlhaGetFile-
        Name() の項などを参照してください。
